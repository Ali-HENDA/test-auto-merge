name: Notify Chat on PR Events

on:
  pull_request:
    types: [opened, reopened, ready_for_review]
  pull_request_review:
    types: [submitted]

jobs:
  notify:
    runs-on: ubuntu-latest
    if: ${{ github.actor != 'dependabot[bot]' }}
    steps:
      - name: Send message to Google Chat
        env:
          WEBHOOK_URL: ${{ secrets.CHAT_WEBHOOK_URL }}
        run: |
          EVENT_NAME="${{ github.event_name }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          ACTOR="${{ github.event.pull_request.user.login }}"
          REVIEW_STATE="${{ github.event.review.state }}"

          if [ "$EVENT_NAME" = "pull_request" ]; then
            MESSAGE="üõ†Ô∏è *${ACTOR}* a cr√©√© une nouvelle PR : [${PR_TITLE}](${PR_URL})"
          elif [ "$EVENT_NAME" = "pull_request_review" ]; then
            if [ "$REVIEW_STATE" = "approved" ]; then
              MESSAGE="‚úÖ *${ACTOR}*, ta PR a √©t√© approuv√©e : [${PR_TITLE}](${PR_URL})"
            elif [ "$REVIEW_STATE" = "changes_requested" ]; then
              MESSAGE="‚ö†Ô∏è *${ACTOR}*, des changements ont √©t√© demand√©s pour ta PR : [${PR_TITLE}](${PR_URL})"
            else
              MESSAGE="üí¨ *${ACTOR}*, un commentaire a √©t√© ajout√© pour ta PR : [${PR_TITLE}](${PR_URL})"
            fi
          fi

          if [ -n "$MESSAGE" ]; then
            curl -X POST -H "Content-Type: application/json" \
              -d "{\"text\": \"${MESSAGE}\"}" \
              "$WEBHOOK_URL"
          fi
